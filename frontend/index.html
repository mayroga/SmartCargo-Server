<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMARTCARGO – SISTEMA INFALIBLE</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    margin:0;
    background:#f4f6f9;
    font-size:16px;
}
header{
    background:#e20613;
    color:white;
    padding:22px;
    text-align:center;
    font-size:1.9em;
    font-weight:bold;
}
.accordion{
    background:white;
    margin:20px;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.accordion-header{
    padding:18px;
    cursor:pointer;
    font-weight:bold;
    border-bottom:1px solid #ddd;
    font-size:1.1em;
}
.accordion-content{
    display:none;
    padding:20px;
}
input,select{
    width:100%;
    padding:12px;
    margin:8px 0 16px 0;
    border-radius:6px;
    border:1px solid #ccc;
    font-size:15px;
}
button{
    background:#e20613;
    color:white;
    border:none;
    padding:14px 24px;
    border-radius:6px;
    cursor:pointer;
    font-size:1.1em;
}
button:hover{
    background:#b10410;
}
.alert{
    padding:14px;
    margin:10px 0;
    border-radius:6px;
    font-size:15px;
}
.critical{ background:#f8d7da; color:#721c24; }
.warning{ background:#fff3cd; color:#856404; }
.success{ background:#d4edda; color:#155724; }
.explicacionIA{
    background:#eef2ff;
    padding:12px;
    margin-bottom:12px;
    border-left:4px solid #4f46e5;
}
#resultado{
    margin:20px;
}
.checklist-box{
    background:#f1f1f1;
    padding:15px;
    border-radius:8px;
    margin-top:15px;
}
</style>
</head>

<body>

<header>SMARTCARGO – SISTEMA INFALIBLE</header>

<form id="cargoForm">

<!-- FASE 1 -->
<div class="accordion">
<div class="accordion-header" onclick="toggleAccordion(this)">
Fase 1: Identificación y Seguridad
</div>
<div class="accordion-content">

<input type="text" name="clientId" placeholder="ID Cliente / Known Shipper">
<select name="highValue">
<option value="">¿Valor mayor a $2,500 USD?</option>
<option value="yes">Sí</option>
<option value="no">No</option>
</select>
<input type="text" name="itnNumber" placeholder="Número ITN (si aplica)">
<input type="text" name="awbMaster" placeholder="AWB Master">
<input type="text" name="originAirport" placeholder="Aeropuerto origen">
<input type="text" name="destinationAirport" placeholder="Aeropuerto destino">
<input type="date" name="departureDate">

</div>
</div>

<!-- FASE 2 -->
<div class="accordion">
<div class="accordion-header" onclick="toggleAccordion(this)">
Fase 2: Anatomía de la Carga
</div>
<div class="accordion-content">

<input type="number" step="0.1" name="pieceHeight" placeholder="Altura mayor (in)">
<input type="number" step="0.1" name="pieceWeight" placeholder="Peso mayor (kg)">
<input type="number" name="numPieces" placeholder="Número de piezas">
<input type="number" step="0.1" name="totalWeight" placeholder="Peso total (kg)">

<select name="needsShoring">
<option value="">¿Necesita Shoring?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>

<select name="nimf15">
<option value="">¿Pallet certificado NIMF-15?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>

<select name="overhang">
<option value="">¿Existe Overhang?</option>
<option value="yes">Sí</option>
<option value="no">No</option>
</select>

</div>
</div>

<!-- FASE 3 -->
<div class="accordion">
<div class="accordion-header" onclick="toggleAccordion(this)">
Fase 3: Tipo de Carga y Documentos
</div>
<div class="accordion-content">

<select name="cargoType" onchange="mostrarDocumentos(this.value)">
<option value="">Tipo de carga</option>
<option value="NORMAL">Normal</option>
<option value="DGR">DGR</option>
<option value="PER">Perishable</option>
<option value="BIO">Biológica</option>
</select>

<div id="documentosDinamicos"></div>

</div>
</div>

<!-- FASE FINAL -->
<div class="accordion">
<div class="accordion-header" onclick="toggleAccordion(this)">
Fase Final: Logística
</div>
<div class="accordion-content">

<input type="text" name="arrivalTime" placeholder="Hora llegada counter">
<select name="packaging">
<option value="">Tipo de embalaje</option>
<option value="straps">Straps</option>
<option value="shrink">Shrink Wrap</option>
</select>
<input type="text" name="zipCode" placeholder="Código Postal">

<div class="checklist-box">
<strong>Checklist obligatorio antes de evaluar:</strong><br><br>
<input type="checkbox" id="check1"> Confirmo que la documentación fue revisada<br>
<input type="checkbox" id="check2"> Confirmo que las medidas son correctas<br>
<input type="checkbox" id="check3"> Confirmo que el embalaje es adecuado<br>
</div>

<br>
<button type="button" onclick="evaluar()">Evaluar Carga</button>
<button type="button" onclick="generarPDF()">Generar PDF</button>

</div>
</div>

</form>

<div id="resultado"></div>

<script>

function toggleAccordion(element){
    const content = element.nextElementSibling;
    content.style.display = content.style.display === "block" ? "none" : "block";
}

function mostrarDocumentos(tipo){
    const contenedor = document.getElementById("documentosDinamicos");
    contenedor.innerHTML="";

    if(tipo === "DGR"){
        contenedor.innerHTML = `
        <div class="checklist-box">
        <strong>Checklist DGR:</strong><br><br>
        <input type="checkbox" name="dgrDocs" value="si"> Shipper's Declaration (2 originales)<br>
        <input type="checkbox" checked disabled> Etiquetas UN correctas<br>
        </div>`;
    }

    if(tipo === "PER"){
        contenedor.innerHTML = `
        <div class="checklist-box">
        <strong>Checklist Perishable:</strong><br><br>
        <input type="checkbox" name="fitoDocs" value="si"> Certificado Fitosanitario<br>
        <input type="checkbox" checked disabled> Control de temperatura validado<br>
        </div>`;
    }

    if(tipo === "BIO"){
        contenedor.innerHTML = `
        <div class="checklist-box">
        <strong>Checklist Biológica:</strong><br><br>
        <input type="checkbox" name="dgrDocs" value="si"> Declaración DGR<br>
        <input type="checkbox" name="fitoDocs" value="si"> Certificado FDA<br>
        </div>`;
    }
}

async function evaluar(){

    if(!document.getElementById("check1").checked ||
       !document.getElementById("check2").checked ||
       !document.getElementById("check3").checked){
        alert("Debe completar el checklist obligatorio antes de evaluar.");
        return;
    }

    const data = Object.fromEntries(new FormData(document.getElementById("cargoForm")).entries());
    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.innerHTML = "Evaluando...";

    try{
        const response = await axios.post("https://smartcargo-server.onrender.com/evaluar", data);

        let html = `<h2>Resultado Final: ${response.data.status}</h2>`;

        response.data.explicaciones.forEach(item => {

            let clase = "info";
            if(item.error.includes("❌")) clase="critical";
            else if(item.error.includes("⚠️")) clase="warning";

            html += `<div class="alert ${clase}">${item.error}</div>`;
            html += `<div class="explicacionIA">${item.explicacion}</div>`;
        });

        resultadoDiv.innerHTML = html;

    }catch(error){
        resultadoDiv.innerHTML = `<div class="alert critical">Error conectando con servidor</div>`;
    }
}

async function generarPDF(){
    const data = Object.fromEntries(new FormData(document.getElementById("cargoForm")).entries());
    const resultadoDiv = document.getElementById("resultado");

    resultadoDiv.innerHTML="Generando PDF...";

    try{
        const response = await axios.post("https://smartcargo-server.onrender.com/generar_pdf", data);
        resultadoDiv.innerHTML = `<a href="https://smartcargo-server.onrender.com${response.data.url}" target="_blank">Abrir Reporte PDF</a>`;
    }catch(error){
        resultadoDiv.innerHTML = `<div class="alert critical">Error generando PDF</div>`;
    }
}

</script>

</body>
</html>
