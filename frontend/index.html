<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SMARTCARGO INFALIBLE</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        color: #111;
    }
    h2 {
        font-size: 20px;
        cursor: pointer;
        background: #222;
        color: white;
        padding: 10px;
        margin: 0;
    }
    .phase-content {
        display: none;
        padding: 15px;
        background: #fff;
        border-bottom: 1px solid #ccc;
    }
    input, select {
        width: 95%;
        padding: 8px;
        margin: 5px 0 15px 0;
        font-size: 16px;
    }
    button {
        padding: 12px 20px;
        font-size: 18px;
        margin: 10px 5px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
    }
    #evaluarBtn { background: #28a745; color: white; }
    #pdfBtn { background: #007bff; color: white; }
    .alert {
        font-size: 14px;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    .alert-error { background: #f8d7da; color: #721c24; }
    .alert-warning { background: #fff3cd; color: #856404; }
    .alert-info { background: #d1ecf1; color: #0c5460; }
    .ia-explanation { font-size: 14px; margin: 2px 0 10px 10px; color: #444; }
</style>
</head>
<body>

<h1 style="text-align:center; padding: 20px; background:#111; color:white;">SMARTCARGO - PRE COUNTER</h1>

<!-- Fase 1 -->
<h2 onclick="togglePhase('phase1')">Fase 1: Identificación y Seguridad ▲</h2>
<div id="phase1" class="phase-content">
    <label>ID Cliente / SCAC:</label>
    <input type="text" id="clientId" placeholder="Opcional para prueba">
    <div id="ex-clientId" class="ia-explanation"></div>

    <label>Tipo de envío:</label>
    <input type="text" id="shipmentType">
    <div id="ex-shipmentType" class="ia-explanation"></div>

    <label>¿Valor > $2,500 USD?</label>
    <select id="highValue">
        <option value="">--Dejar en blanco--</option>
        <option value="yes">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-highValue" class="ia-explanation"></div>

    <label>Número ITN (si aplica):</label>
    <input type="text" id="itnNumber">
    <div id="ex-itnNumber" class="ia-explanation"></div>

    <label>AWB Master:</label>
    <input type="text" id="awbMaster">
    <div id="ex-awbMaster" class="ia-explanation"></div>

    <label>AWB House (si aplica):</label>
    <input type="text" id="awbHouse">
    <div id="ex-awbHouse" class="ia-explanation"></div>

    <label>Reference Number:</label>
    <input type="text" id="referenceNumber">
    <div id="ex-referenceNumber" class="ia-explanation"></div>

    <label>Aeropuerto de origen:</label>
    <input type="text" id="originAirport">
    <div id="ex-originAirport" class="ia-explanation"></div>

    <label>Aeropuerto de destino:</label>
    <input type="text" id="destinationAirport">
    <div id="ex-destinationAirport" class="ia-explanation"></div>

    <label>Fecha de salida (mm/dd/yyyy):</label>
    <input type="date" id="departureDate">
    <div id="ex-departureDate" class="ia-explanation"></div>
</div>

<!-- Fase 2 -->
<h2 onclick="togglePhase('phase2')">Fase 2: Anatomía de la Carga ▲</h2>
<div id="phase2" class="phase-content">
    <label>Altura de la pieza (inches):</label>
    <input type="number" id="pieceHeight">
    <div id="ex-pieceHeight" class="ia-explanation"></div>

    <label>Número de piezas:</label>
    <input type="number" id="numPieces">
    <div id="ex-numPieces" class="ia-explanation"></div>

    <label>Peso total (kg):</label>
    <input type="number" id="totalWeight">
    <div id="ex-totalWeight" class="ia-explanation"></div>

    <label>Dimensiones (LxAnxAl):</label>
    <input type="text" id="dimensions">
    <div id="ex-dimensions" class="ia-explanation"></div>

    <label>¿Necesita Shoring?</label>
    <select id="needsShoring">
        <option value="">--Dejar en blanco--</option>
        <option value="si">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-needsShoring" class="ia-explanation"></div>

    <label>Pallet NIMF-15:</label>
    <select id="nimf15">
        <option value="">--Dejar en blanco--</option>
        <option value="si">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-nimf15" class="ia-explanation"></div>

    <label>¿Overhang?</label>
    <select id="overhang">
        <option value="">--Dejar en blanco--</option>
        <option value="yes">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-overhang" class="ia-explanation"></div>

    <label>¿Hay daños preexistentes?</label>
    <select id="damaged">
        <option value="">--Dejar en blanco--</option>
        <option value="yes">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-damaged" class="ia-explanation"></div>
</div>

<!-- Fase 3 -->
<h2 onclick="togglePhase('phase3')">Fase 3: Contenidos Críticos ▲</h2>
<div id="phase3" class="phase-content">
    <label>Tipo de carga (Normal / DGR / PER / BIO):</label>
    <select id="cargoType">
        <option value="">--Dejar en blanco--</option>
        <option value="Normal">Normal</option>
        <option value="DGR">DGR</option>
        <option value="PER">Perecedero</option>
        <option value="BIO">Biológico</option>
    </select>
    <div id="ex-cargoType" class="ia-explanation"></div>

    <label>Documentos DGR completos:</label>
    <select id="dgrDocs">
        <option value="">--Dejar en blanco--</option>
        <option value="si">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-dgrDocs" class="ia-explanation"></div>

    <label>Certificados FDA/Fitosanitarios:</label>
    <select id="fitoDocs">
        <option value="">--Dejar en blanco--</option>
        <option value="si">Sí</option>
        <option value="no">No</option>
    </select>
    <div id="ex-fitoDocs" class="ia-explanation"></div>
</div>

<!-- Fase 4-8 -->
<h2 onclick="togglePhase('phase4')">Fase 4-8: Check-list y Logística ▲</h2>
<div id="phase4" class="phase-content">
    <label>Hora estimada de llegada al counter:</label>
    <input type="time" id="arrivalTime">
    <div id="ex-arrivalTime" class="ia-explanation"></div>

    <label>Tipo de embalaje (straps/shrink wrap):</label>
    <input type="text" id="packaging">
    <div id="ex-packaging" class="ia-explanation"></div>

    <label>Etiquetas (Frágil, Arrow, etc.):</label>
    <input type="text" id="labels">
    <div id="ex-labels" class="ia-explanation"></div>

    <label>Fragilidad de la carga:</label>
    <input type="text" id="fragile">
    <div id="ex-fragile" class="ia-explanation"></div>

    <label>Nombre del Shipper:</label>
    <input type="text" id="shipperName">
    <div id="ex-shipperName" class="ia-explanation"></div>

    <label>Dirección del Shipper:</label>
    <input type="text" id="shipperAddress">
    <div id="ex-shipperAddress" class="ia-explanation"></div>

    <label>Teléfono del Shipper:</label>
    <input type="text" id="shipperPhone">
    <div id="ex-shipperPhone" class="ia-explanation"></div>

    <label>Nombre del Consignee:</label>
    <input type="text" id="consigneeName">
    <div id="ex-consigneeName" class="ia-explanation"></div>

    <label>Dirección del Consignee:</label>
    <input type="text" id="consigneeAddress">
    <div id="ex-consigneeAddress" class="ia-explanation"></div>

    <label>Teléfono del Consignee:</label>
    <input type="text" id="consigneePhone">
    <div id="ex-consigneePhone" class="ia-explanation"></div>

    <label>Código Postal:</label>
    <input type="text" id="zipCode">
    <div id="ex-zipCode" class="ia-explanation"></div>
</div>

<div style="text-align:center; margin: 20px;">
    <button id="evaluarBtn" onclick="evaluarCarga()">Evaluar Carga</button>
    <button id="pdfBtn" onclick="generarPDF()">Generar PDF</button>
</div>

<div id="alertas" style="text-align:center;"></div>

<script>
function togglePhase(phaseId) {
    const el = document.getElementById(phaseId);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

// Obtener datos del formulario
function getFormData() {
    return {
        clientId: document.getElementById('clientId').value,
        shipmentType: document.getElementById('shipmentType').value,
        highValue: document.getElementById('highValue').value,
        itnNumber: document.getElementById('itnNumber').value,
        awbMaster: document.getElementById('awbMaster').value,
        awbHouse: document.getElementById('awbHouse').value,
        referenceNumber: document.getElementById('referenceNumber').value,
        originAirport: document.getElementById('originAirport').value,
        destinationAirport: document.getElementById('destinationAirport').value,
        departureDate: document.getElementById('departureDate').value,
        pieceHeight: parseFloat(document.getElementById('pieceHeight').value) || 0,
        numPieces: parseInt(document.getElementById('numPieces').value) || 0,
        totalWeight: parseFloat(document.getElementById('totalWeight').value) || 0,
        dimensions: document.getElementById('dimensions').value,
        needsShoring: document.getElementById('needsShoring').value,
        nimf15: document.getElementById('nimf15').value,
        overhang: document.getElementById('overhang').value,
        damaged: document.getElementById('damaged').value,
        cargoType: document.getElementById('cargoType').value,
        dgrDocs: document.getElementById('dgrDocs').value,
        fitoDocs: document.getElementById('fitoDocs').value,
        arrivalTime: document.getElementById('arrivalTime').value,
        packaging: document.getElementById('packaging').value,
        labels: document.getElementById('labels').value,
        fragile: document.getElementById('fragile').value,
        shipperName: document.getElementById('shipperName').value,
        shipperAddress: document.getElementById('shipperAddress').value,
        shipperPhone: document.getElementById('shipperPhone').value,
        consigneeName: document.getElementById('consigneeName').value,
        consigneeAddress: document.getElementById('consigneeAddress').value,
        consigneePhone: document.getElementById('consigneePhone').value,
        zipCode: document.getElementById('zipCode').value
    };
}

// Evaluar carga
async function evaluarCarga() {
    const data = getFormData();
    clearExplanations();
    document.getElementById('alertas').innerHTML = "Evaluando...";
    try {
        const response = await axios.post('https://smartcargo-server.onrender.com/evaluar', data);
        const res = response.data;
        document.getElementById('alertas').innerHTML = `<div class="alert ${res.status==='LISTO PARA VOLAR'?'alert-info':'alert-error'}">Status: ${res.status}</div>`;

        // Mostrar explicaciones debajo de cada input
        res.explicaciones.forEach(exp => {
            for (const key in data) {
                if (exp.error.toLowerCase().includes(key.toLowerCase())) {
                    const el = document.getElementById('ex-' + key);
                    if(el) el.innerText = exp.explicacion;
                }
            }
        });
    } catch(err) {
        document.getElementById('alertas').innerHTML = `<div class="alert alert-error">❌ Error al evaluar la carga: ${err}</div>`;
    }
}

// Generar PDF
async function generarPDF() {
    const data = getFormData();
    try {
        const response = await axios.post('https://smartcargo-server.onrender.com/generar_pdf', data);
        const pdfUrl = response.data.url;
        window.open(pdfUrl, '_blank');
    } catch(err) {
        document.getElementById('alertas').innerHTML = `<div class="alert alert-error">❌ Error al generar PDF: ${err}</div>`;
    }
}

function clearExplanations() {
    document.querySelectorAll('.ia-explanation').forEach(el => el.innerText = '');
}
</script>
</body>
</html>
