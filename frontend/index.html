<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AL CIELO | Pre-Check Avianca Cargo Miami</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
:root { --avianca: #e20613; --gold: #b2945e; --dark: #1a1a1a; --danger: #dc3545; }
body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f4f4f4; margin: 0; color: var(--dark); }
.header { background: var(--avianca); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.container { max-width: 700px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

/* Secciones y Cortinas */
.fase { padding: 25px; border-bottom: 1px solid #eee; }
.fase h2 { color: var(--avianca); font-size: 18px; margin-top: 0; display: flex; align-items: center; }
.fase h2 span { background: var(--avianca); color: white; border-radius: 50%; width: 25px; height: 25px; display: inline-flex; justify-content: center; align-items: center; margin-right: 10px; font-size: 14px; }

.instruccion-pro { background: #fff3f3; border-left: 4px solid var(--avianca); padding: 15px; margin: 10px 0; font-size: 14px; color: #333; }
.instruccion-pro b { color: var(--avianca); }

label { display: block; margin: 15px 0 5px; font-weight: 600; font-size: 15px; }
select, input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; }

/* Ramificaciones Ocultas */
.cortina { display: none; background: #fafafa; padding: 20px; border-radius: 8px; margin-top: 15px; border: 1px dashed #bbb; }

.btn-main { background: var(--avianca); color: white; width: 100%; padding: 18px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; }
.btn-main:hover { background: #b3050f; }

#resultado { display: none; padding: 30px; text-align: center; }
.status-box { padding: 20px; border-radius: 8px; font-weight: bold; font-size: 22px; margin-bottom: 20px; }
</style>
</head>
<body>

<div class="header">
    <h1 style="margin:0;">AL CIELO</h1>
    <small>SmartCargo Advisory | Counter de Avianca Cargo Miami</small>
</div>

<div class="container">
<form id="counterForm">

    <div class="fase">
        <h2><span>1</span> Identificaci√≥n (Filtro TSA)</h2>
        <label>ID de Cliente / SCAC Code:</label>
        <input type="text" id="clientId" placeholder="Ingrese c√≥digo de empresa" required onchange="validarKnown()">
        <div id="warnKnown" class="instruccion-pro" style="display:none;">
            <b>‚ö†Ô∏è ATENCI√ìN TSA:</b> Si no es Known Shipper, su carga ir√° a inspecci√≥n f√≠sica (24-48h).
        </div>
        
        <label>¬øTipo de Env√≠o?</label>
        <select id="shipmentType" onchange="toggleConsolidado()">
            <option value="directo">Directo (Master AWB √önica)</option>
            <option value="consolidado">Consolidado (Master + Houses)</option>
        </select>

        <div id="cortinaConsolidado" class="cortina">
            <div class="instruccion-pro">
                <b>üìÑ REQUISITO MANIFIESTO:</b> Debe traer el Manifiesto de Carga original. 
                Verifique que la suma de pesos de las Houses coincida exacto con la Master.
            </div>
            <label>¬øTiene el Manifiesto de Carga impreso?</label>
            <select id="hasManifest"><option value="si">S√≠</option><option value="no">No</option></select>
        </div>
    </div>

    <div class="fase">
        <h2><span>2</span> Papeler√≠a y Aduana (Pouch/CBP)</h2>
        <div class="instruccion-pro">
            <b>üìÅ ORGANIZACI√ìN DEL SOBRE:</b> 3 Originales <b>DENTRO</b> del sobre. 
            6 Copias <b>FUERA</b> con clip (No use grapas).
        </div>
        
        <label>¬øValor de la mercanc√≠a supera los $2,500 USD?</label>
        <select id="highValue" onchange="toggleITN()">
            <option value="no">No</option>
            <option value="yes">S√≠</option>
        </select>

        <div id="cortinaITN" class="cortina">
            <label>N√∫mero de ITN (AES):</label>
            <input type="text" id="itnNumber" placeholder="X2026...">
            <div class="instruccion-pro">
                <b>‚öñÔ∏è RIESGO FEDERAL:</b> Sin ITN, la multa de CBP es de $10,000 USD.
            </div>
        </div>

        <label>¬øZip Code de destino validado?</label>
        <select id="zipCheck"><option value="si">S√≠</option><option value="no">No</option></select>
    </div>

    <div class="fase">
        <h2><span>3</span> Clasificaci√≥n de Carga (IATA/DOT)</h2>
        <label>Naturaleza de la Mercanc√≠a:</label>
        <select id="cargoType" onchange="toggleRamaCarga()">
            <option value="GEN">Carga General (GEN)</option>
            <option value="DGR">Mercanc√≠a Peligrosa (DGR)</option>
            <option value="PER">Perecederos / FDA (PER)</option>
        </select>

        <div id="ramaDGR" class="cortina">
            <div class="instruccion-pro"><b>‚ö†Ô∏è REGLA DE ORO DGR:</b> Requiere 2 Shipper's Declaration originales con bordes rojos fuera del sobre.</div>
            <label>¬øTrae Shipper's Declaration originales?</label>
            <select id="dgrDocs"><option value="si">S√≠</option><option value="no">No</option></select>
        </div>

        <div id="ramaPER" class="cortina">
            <div class="instruccion-pro"><b>üçé FILTRO AGRICULTURA:</b> Certificado Fitosanitario original debe ir FUERA del sobre.</div>
            <label>¬øTiene Fito/FDA en mano?</label>
            <select id="fitoDocs"><option value="si">S√≠</option><option value="no">No</option></select>
        </div>
    </div>

    <div class="fase">
        <h2><span>4</span> Anatom√≠a de Carga (Avianca Fleet)</h2>
        <label>Altura de la pieza m√°s alta (pulgadas):</label>
        <input type="number" id="pieceHeight" placeholder="Mida desde el suelo" onchange="validarAltura()">
        <div id="warnAltura" class="instruccion-pro" style="display:none;"></div>

        <label>¬øAlguna pieza pesa m√°s de 150 kg (330 lbs)?</label>
        <select id="needsShoring">
            <option value="no">No</option>
            <option value="si">S√≠</option>
        </select>
        <div class="instruccion-pro"><b>üõ† SHORING:</b> Si pesa >150kg, el counter exige tablas de madera de 2" de grosor.</div>
    </div>

    <div class="fase">
        <h2><span>5</span> Inspecci√≥n F√≠sica (Rampa)</h2>
        <label>¬øMadera tiene sello NIMF-15 visible?</label>
        <select id="nimf15"><option value="yes">S√≠</option><option value="no">No</option></select>
        <label>¬øCajas con da√±os, roturas o humedad?</label>
        <select id="damaged"><option value="no">No</option><option value="yes">S√≠</option></select>
        <label>¬øOverhang (carga sobresale de la base)?</label>
        <select id="overhang"><option value="0">No</option><option value="1">S√≠</option></select>
    </div>

    <button type="button" class="btn-main" onclick="evaluarCounter()">VERIFICAR SI VUELA O NO VUELA</button>
</form>

<div id="resultado">
    <div id="statusBox" class="status-box"></div>
    <div id="detalles" style="text-align: left; margin-bottom: 20px;"></div>
    <button type="button" class="btn-main" style="background:#444;" onclick="location.reload()">NUEVA INSPECCI√ìN</button>
    <div id="pdfLink" style="margin-top:20px;"></div>
</div>
</div>

<script>
function toggleConsolidado() {
    document.getElementById('cortinaConsolidado').style.display = 
        document.getElementById('shipmentType').value === 'consolidado' ? 'block' : 'none';
}
function toggleITN() {
    document.getElementById('cortinaITN').style.display = 
        document.getElementById('highValue').value === 'yes' ? 'block' : 'none';
}
function toggleRamaCarga() {
    const type = document.getElementById('cargoType').value;
    document.getElementById('ramaDGR').style.display = (type === 'DGR') ? 'block' : 'none';
    document.getElementById('ramaPER').style.display = (type === 'PER') ? 'block' : 'none';
}
function validarAltura() {
    const h = document.getElementById('pieceHeight').value;
    const warn = document.getElementById('warnAltura');
    warn.style.display = 'block';
    if (h > 96) warn.innerHTML = "<b>‚ùå RECHAZO:</b> No entra en ning√∫n avi√≥n de Avianca.";
    else if (h > 63) warn.innerHTML = "<b>‚ö†Ô∏è CARGUERO:</b> Solo puede viajar en avi√≥n carguero (Main Deck).";
    else warn.style.display = 'none';
}

async function evaluarCounter() {
    const data = {
        clientId: document.getElementById('clientId').value,
        highValue: document.getElementById('highValue').value,
        itnNumber: document.getElementById('itnNumber').value || "",
        shipmentType: document.getElementById('shipmentType').value,
        pieceHeight: parseFloat(document.getElementById('pieceHeight').value),
        nimf15: document.getElementById('nimf15').value,
        damagedBoxes: document.getElementById('damaged').value,
        overhang: parseFloat(document.getElementById('overhang').value),
        pieceWeight: document.getElementById('needsShoring').value === 'si' ? 151 : 50,
        awbCopies: "yes", straps: "yes", awbOnBoxes: "yes",
        oldLabels: "no", cleanCargo: "yes", fragileLabels: "yes",
        piecesMatch: "yes", tanks: "no", palletType: "PMC",
        origin: "no", dangerousGoods: "no", zipCode: document.getElementById('zipCheck').value,
        arrivalTime: "12:00"
    };

    try {
        const res = await axios.post('/evaluar', data);
        document.getElementById('counterForm').style.display = 'none';
        document.getElementById('resultado').style.display = 'block';

        const box = document.getElementById('statusBox');
        box.innerText = res.data.status;
        box.style.background = res.data.status.includes('LISTO') ? '#28a745' : '#dc3545';
        box.style.color = 'white';

        let list = "<ul>";
        res.data.detalle.forEach(d => list += `<li>${d}</li>`);
        list += "</ul>";
        document.getElementById('detalles').innerHTML = list;

        // Abrir PDF autom√°ticamente en nueva pesta√±a sin prompt
        const pdf = await axios.post('/generar_pdf', data);
        const pdfUrl = window.location.origin + pdf.data.url;
        document.getElementById('pdfLink').innerHTML = `<a href="${pdfUrl}" target="_blank" rel="noopener">üìÑ DESCARGAR REPORTE DE COUNTER (PDF)</a>`;
        window.open(pdfUrl, '_blank', 'noopener');
    } catch (e) {
        alert("Error en el sistema. Revise conexi√≥n o datos ingresados.");
        console.error(e);
    }
}
</script>

</body>
</html>
