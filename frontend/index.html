<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMARTCARGO - AL CIELO</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f9f9f9;
        margin: 0;
        padding: 0;
        color: #222;
    }
    header {
        background-color: #e20613;
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 1.8em;
        font-weight: bold;
    }
    section {
        margin: 20px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
        cursor: pointer;
        font-size: 1.5em;
        margin: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .content {
        display: none;
        margin-top: 10px;
        font-size: 1.1em;
    }
    input, select {
        width: 100%;
        padding: 10px;
        margin: 6px 0 5px 0;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 1em;
    }
    .ia-feedback {
        font-size: 0.95em;
        margin-bottom: 10px;
        padding: 6px;
        border-radius: 5px;
    }
    .ia-ok { background-color: #d4edda; color: #155724; }
    .ia-warning { background-color: #fff3cd; color: #856404; }
    .ia-error { background-color: #f8d7da; color: #721c24; }
    button {
        background-color: #e20613;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        font-size: 1.1em;
        cursor: pointer;
        margin: 5px 5px 15px 0;
    }
    button:hover {
        background-color: #b10410;
    }
    .arrow {
        font-size: 1.3em;
    }
    #resultado, #pdfLink {
        margin: 20px;
        padding: 15px;
        background: #dff0d8;
        border-radius: 10px;
        font-size: 1.2em;
    }
</style>
</head>
<body>

<header>SMARTCARGO - AL CIELO</header>

<form id="cargoForm">

    <!-- Fase 1: Identificaci√≥n y Seguridad -->
    <section>
        <h2 onclick="toggleSection(this)">Fase 1: Identificaci√≥n y Seguridad <span class="arrow">‚ñº</span></h2>
        <div class="content">
            <input type="text" name="clientId" placeholder="ID Cliente / SCAC">
            <div class="ia-feedback" id="fb-clientId"></div>

            <select name="shipmentType">
                <option value="" disabled selected>Tipo de env√≠o</option>
                <option value="directo">Directo</option>
                <option value="consolidado">Consolidado</option>
            </select>
            <div class="ia-feedback" id="fb-shipmentType"></div>

            <select name="highValue">
                <option value="" disabled selected>¬øValor > $2,500 USD?</option>
                <option value="yes">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-highValue"></div>

            <input type="text" name="itnNumber" placeholder="N√∫mero ITN (si aplica)">
            <div class="ia-feedback" id="fb-itnNumber"></div>

            <input type="text" name="awbMaster" placeholder="AWB Master">
            <div class="ia-feedback" id="fb-awbMaster"></div>

            <input type="text" name="awbHouse" placeholder="AWB House (si aplica)">
            <div class="ia-feedback" id="fb-awbHouse"></div>

            <input type="text" name="referenceNumber" placeholder="Reference Number">
            <div class="ia-feedback" id="fb-referenceNumber"></div>

            <input type="text" name="originAirport" placeholder="Aeropuerto de origen">
            <div class="ia-feedback" id="fb-originAirport"></div>

            <input type="text" name="destinationAirport" placeholder="Aeropuerto de destino">
            <div class="ia-feedback" id="fb-destinationAirport"></div>

            <input type="date" name="departureDate" placeholder="Fecha de salida">
            <div class="ia-feedback" id="fb-departureDate"></div>
        </div>
    </section>

    <!-- Fase 2: Anatom√≠a de la Carga -->
    <section>
        <h2 onclick="toggleSection(this)">Fase 2: Anatom√≠a de la Carga <span class="arrow">‚ñº</span></h2>
        <div class="content">
            <input type="number" step="0.1" name="pieceHeight" placeholder="Altura de la pieza (inches)">
            <div class="ia-feedback" id="fb-pieceHeight"></div>

            <input type="number" name="numPieces" placeholder="N√∫mero de piezas">
            <div class="ia-feedback" id="fb-numPieces"></div>

            <input type="number" step="0.1" name="totalWeight" placeholder="Peso total (kg)">
            <div class="ia-feedback" id="fb-totalWeight"></div>

            <input type="text" name="dimensions" placeholder="Dimensiones (LxAnxAl)">
            <div class="ia-feedback" id="fb-dimensions"></div>

            <select name="needsShoring">
                <option value="" disabled selected>¬øNecesita Shoring?</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-needsShoring"></div>

            <select name="nimf15">
                <option value="" disabled selected>Pallet NIMF-15</option>
                <option value="yes">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-nimf15"></div>

            <select name="overhang">
                <option value="" disabled selected>¬øOverhang?</option>
                <option value="yes">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-overhang"></div>

            <select name="damaged">
                <option value="" disabled selected>¬øDa√±os preexistentes?</option>
                <option value="yes">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-damaged"></div>
        </div>
    </section>

    <!-- Fase 3: Contenidos Cr√≠ticos -->
    <section>
        <h2 onclick="toggleSection(this)">Fase 3: Contenidos Cr√≠ticos <span class="arrow">‚ñº</span></h2>
        <div class="content">
            <select name="cargoType">
                <option value="" disabled selected>Tipo de carga</option>
                <option value="NORMAL">Normal</option>
                <option value="DGR">Mercanc√≠a Peligrosa</option>
                <option value="PER">Perishable</option>
                <option value="BIO">Biol√≥gica</option>
            </select>
            <div class="ia-feedback" id="fb-cargoType"></div>

            <select name="dgrDocs">
                <option value="" disabled selected>Documentos DGR completos</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-dgrDocs"></div>

            <select name="fitoDocs">
                <option value="" disabled selected>Certificados FDA/Fitosanitarios</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
            </select>
            <div class="ia-feedback" id="fb-fitoDocs"></div>
        </div>
    </section>

    <!-- Fase 4-8: Check final, embalaje y log√≠stica -->
    <section>
        <h2 onclick="toggleSection(this)">Fase 4-8: Check-list y Log√≠stica <span class="arrow">‚ñº</span></h2>
        <div class="content">
            <input type="text" name="arrivalTime" placeholder="Hora estimada de llegada al counter">
            <div class="ia-feedback" id="fb-arrivalTime"></div>

            <input type="text" name="packaging" placeholder="Tipo de embalaje (straps/shrink wrap)">
            <div class="ia-feedback" id="fb-packaging"></div>

            <input type="text" name="labels" placeholder="Etiquetas (Fr√°gil, Arrow, etc.)">
            <div class="ia-feedback" id="fb-labels"></div>

            <input type="text" name="fragile" placeholder="Fragilidad de la carga">
            <div class="ia-feedback" id="fb-fragile"></div>

            <input type="text" name="shipperName" placeholder="Nombre del Shipper">
            <div class="ia-feedback" id="fb-shipperName"></div>

            <input type="text" name="shipperAddress" placeholder="Direcci√≥n del Shipper">
            <div class="ia-feedback" id="fb-shipperAddress"></div>

            <input type="text" name="shipperPhone" placeholder="Tel√©fono del Shipper">
            <div class="ia-feedback" id="fb-shipperPhone"></div>

            <input type="text" name="consigneeName" placeholder="Nombre del Consignee">
            <div class="ia-feedback" id="fb-consigneeName"></div>

            <input type="text" name="consigneeAddress" placeholder="Direcci√≥n del Consignee">
            <div class="ia-feedback" id="fb-consigneeAddress"></div>

            <input type="text" name="consigneePhone" placeholder="Tel√©fono del Consignee">
            <div class="ia-feedback" id="fb-consigneePhone"></div>

            <input type="text" name="zipCode" placeholder="C√≥digo Postal">
            <div class="ia-feedback" id="fb-zipCode"></div>
        </div>
    </section>

    <button type="button" onclick="enviarEvaluacion()">Evaluar Carga</button>
    <button type="button" onclick="generarPDF()">Generar PDF</button>
</form>

<div id="resultado"></div>
<div id="pdfLink"></div>

<script>
function toggleSection(header) {
    const content = header.nextElementSibling;
    if (content.style.display === "block") {
        content.style.display = "none";
        header.querySelector(".arrow").textContent = "‚ñº";
    } else {
        content.style.display = "block";
        header.querySelector(".arrow").textContent = "‚ñ≤";
    }
}

async function enviarEvaluacion() {
    const form = document.getElementById("cargoForm");
    const data = Object.fromEntries(new FormData(form).entries());

    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.textContent = "‚è≥ Evaluando, por favor espere...";

    try {
        const response = await axios.post("https://smartcargo-server.onrender.com/evaluar", data);
        const detalles = response.data.detalles;
        const explicaciones = response.data.explicaciones;

        // Mostrar cada feedback IA debajo del input correspondiente
        for (const item of explicaciones) {
            const name = item.error;
            const el = document.getElementById(`fb-${name}`);
            if(el){
                // Asignar color seg√∫n nivel de gravedad
                let clase = "ia-ok";
                if(item.nivel==="ADVERTENCIA") clase="ia-warning";
                else if(item.nivel==="CRITICO") clase="ia-error";
                el.textContent = item.explicacion;
                el.className = "ia-feedback " + clase;
            }
        }

        let html = `<h3>Resultado: ${response.data.status}</h3>`;
        resultadoDiv.innerHTML = html;

    } catch(err) {
        resultadoDiv.textContent = "‚ùå Error al evaluar la carga: " + err;
    }
}

async function generarPDF() {
    const form = document.getElementById("cargoForm");
    const data = Object.fromEntries(new FormData(form).entries());

    const pdfDiv = document.getElementById("pdfLink");
    pdfDiv.textContent = "‚è≥ Generando PDF...";

    try {
        const response = await axios.post("https://smartcargo-server.onrender.com/generar_pdf", data);
        pdfDiv.innerHTML = `<a href="https://smartcargo-server.onrender.com${response.data.url}" target="_blank">üìÑ Abrir PDF AL CIELO</a>`;
    } catch(err) {
        pdfDiv.textContent = "‚ùå Error al generar PDF: " + err;
    }
}
</script>

</body>
</html>
