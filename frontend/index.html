<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SMARTCARGO CERTIFIED</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#e20613;color:white;padding:20px;text-align:center;font-size:24px}
section{background:white;margin:20px;padding:20px;border-radius:8px}
input,select{width:100%;padding:10px;margin:6px 0}
button{background:#e20613;color:white;padding:12px;border:none;width:100%}
.alert{padding:10px;margin:6px 0;border-radius:5px}
.critical{background:#f8d7da}
.warning{background:#fff3cd}
.success{background:#d4edda}
#timer{color:red;text-align:right}
img.preview{max-width:100%;cursor:pointer}
</style>
</head>
<body>

<header>SMARTCARGO CERTIFIED</header>
<div id="timer">59</div>

<form id="form">

<section>
<h3>AWB Data</h3>
<input name="awbMaster" placeholder="AWB 123-12345678" oninput="validarAWB(this)">
<input name="originAirport" placeholder="Origen (MIA)" oninput="validarIATA(this)">
<input name="destinationAirport" placeholder="Destino (BOG)" oninput="validarIATA(this)">
<input name="zipCode" placeholder="ZIP 5 dígitos" oninput="validarZIP(this)">
</section>

<section>
<h3>Dimensiones</h3>
<input name="pieceHeight" type="number" placeholder="Altura mayor (in)">
<input name="pieceWeight" type="number" placeholder="Peso mayor (kg)">
<select name="needsShoring">
<option value="">¿Shoring?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
<select name="nimf15">
<option value="">NIMF-15</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
</section>

<section>
<h3>Tipo Carga</h3>
<select name="cargoType">
<option value="">Tipo</option>
<option value="NORMAL">Normal</option>
<option value="DGR">DGR</option>
</select>
<select name="dgrDocs">
<option value="">Docs DGR</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
</section>

<section>
<h3>Upload Evidencia</h3>
<input type="file" onchange="preview(event)">
<div id="preview"></div>
</section>

<button type="button" onclick="evaluar()">EVALUAR</button>
<button type="button" onclick="pdf()">GENERAR PDF</button>

</form>

<div id="resultado"></div>

<script>

let tiempo=59;
setInterval(()=>{
 tiempo--;
 document.getElementById("timer").innerText=tiempo;
 if(tiempo<=0){alert("Sesión cerrada");location.reload();}
},1000);

function validarAWB(i){
 const r=/^\d{3}-\d{8}$/;
 i.style.border=r.test(i.value)?"2px solid green":"2px solid red";
}
function validarZIP(i){
 const r=/^\d{5}$/;
 i.style.border=r.test(i.value)?"2px solid green":"2px solid red";
}
function validarIATA(i){
 const r=/^[A-Z]{3}$/;
 i.style.border=r.test(i.value)?"2px solid green":"2px solid red";
}

function preview(e){
 const img=document.createElement("img");
 img.src=URL.createObjectURL(e.target.files[0]);
 img.className="preview";
 img.onclick=()=>img.style.transform="scale(2)";
 document.getElementById("preview").appendChild(img);
}

async function evaluar(){
 const data=Object.fromEntries(new FormData(form).entries());
 const r=await axios.post("/evaluar",data);
 let html="<h2>"+r.data.status+"</h2>";
 r.data.explicaciones.forEach(e=>{
   html+="<div class='alert'>["+e.autoridad+"] "+e.hallazgo+"</div>";
   html+="<div>"+e.explicacion+"</div>";
 });
 resultado.innerHTML=html;
}

async function pdf(){
 const data=Object.fromEntries(new FormData(form).entries());
 const r=await axios.post("/generar_pdf",data);
 window.open(r.data.url);
}

</script>
</body>
</html>
