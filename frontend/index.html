<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMARTCARGO – SISTEMA INFALIBLE</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f4f6f9}
header{background:#e20613;color:white;padding:20px;text-align:center;font-size:1.8em;font-weight:bold}
section{background:white;margin:20px;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:none}
section.active{display:block}
h2{margin-top:0;border-bottom:2px solid #e20613;padding-bottom:5px}
input,select{width:100%;padding:10px;margin:6px 0 15px 0;border-radius:5px;border:1px solid #ccc}
button{background:#e20613;color:white;border:none;padding:12px 20px;border-radius:5px;cursor:pointer;font-size:1.1em}
button:hover{background:#b10410}
.alert{padding:10px;margin:8px 0;border-radius:5px}
.critical{background:#f8d7da;color:#721c24}
.warning{background:#fff3cd;color:#856404}
.success{background:#d4edda;color:#155724}
.info{background:#d1ecf1;color:#0c5460}
#resultado{margin:20px}
.explicacionIA{background:#eef2ff;padding:10px;margin-top:5px;border-left:4px solid #4f46e5;font-size:0.95em}
.smallinfo{font-size:0.9em;background:#f1f1f1;padding:8px;border-radius:5px;margin-bottom:10px}
</style>
</head>
<body>
<header>SMARTCARGO – SISTEMA INFALIBLE</header>
<form id="cargoForm">

<!-- FASE 1 -->
<section class="active" id="fase1">
<h2>Fase 1: Identificación y Seguridad</h2>
<input type="text" name="clientId" placeholder="ID Cliente / Known Shipper">
<select name="highValue">
<option value="">¿Valor mayor a $2,500 USD?</option>
<option value="yes">Sí</option>
<option value="no">No</option>
</select>
<input type="text" name="itnNumber" placeholder="Número ITN (si aplica)">
<input type="text" name="awbMaster" placeholder="AWB Master">
<input type="text" name="originAirport" placeholder="Aeropuerto origen">
<input type="text" name="destinationAirport" placeholder="Aeropuerto destino">
<input type="date" name="departureDate">
<button type="button" onclick="siguienteFase(1)">Siguiente</button>
</section>

<!-- FASE 2 -->
<section id="fase2">
<h2>Fase 2: Anatomía de la Carga</h2>
<div class="smallinfo">Altura pasajero:63 in, Carguero:96 in. Pieza>150kg necesita SHORING.</div>
<input type="number" step="0.1" name="pieceHeight" placeholder="Altura de la pieza (in)">
<input type="number" step="0.1" name="totalWeight" placeholder="Peso total (kg)">
<input type="number" name="numPieces" placeholder="Número total de piezas">
<select name="needsShoring">
<option value="">¿Necesita Shoring?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
<select name="nimf15">
<option value="">¿Pallet certificado NIMF-15?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
<select name="overhang">
<option value="">¿Existe Overhang?</option>
<option value="yes">Sí</option>
<option value="no">No</option>
</select>
<select name="damaged">
<option value="">¿Daños visibles?</option>
<option value="yes">Sí</option>
<option value="no">No</option>
</select>
<button type="button" onclick="siguienteFase(2)">Siguiente</button>
</section>

<!-- FASE 3 -->
<section id="fase3">
<h2>Fase 3: Contenidos Críticos</h2>
<div class="smallinfo">
DGR: Mercancía peligrosa.<br>
PER: Perecedero.<br>
BIO: Biológica.
</div>
<select name="cargoType">
<option value="">Tipo de carga</option>
<option value="NORMAL">Normal</option>
<option value="DGR">DGR</option>
<option value="PER">Perishable</option>
<option value="BIO">Biológica</option>
</select>
<select name="dgrDocs">
<option value="">¿Documentos DGR completos?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
<select name="fitoDocs">
<option value="">¿Certificados FDA/Fitosanitarios?</option>
<option value="si">Sí</option>
<option value="no">No</option>
</select>
<button type="button" onclick="siguienteFase(3)">Siguiente</button>
</section>

<!-- FASE FINAL -->
<section id="fase4">
<h2>Fase Final: Logística y Embalaje</h2>
<input type="text" name="arrivalTime" placeholder="Hora llegada counter">
<select name="packaging">
<option value="">Tipo de embalaje</option>
<option value="straps">Straps</option>
<option value="shrink">Shrink Wrap</option>
</select>
<input type="text" name="zipCode" placeholder="Código Postal">
<button type="button" onclick="evaluar()">Evaluar Carga</button>
<button type="button" onclick="generarPDF()">Generar PDF</button>
</section>
</form>

<div id="resultado"></div>

<script>
function siguienteFase(fase){
    document.getElementById("fase"+fase).classList.remove("active");
    document.getElementById("fase"+(fase+1)).classList.add("active");
}

async function evaluar(){
    const data = Object.fromEntries(new FormData(document.getElementById("cargoForm")).entries());
    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.innerHTML = "Evaluando...";
    try{
        const response = await axios.post("/evaluar", data);
        let html = `<h2>Resultado Final: ${response.data.status}</h2>`;
        response.data.explicaciones.forEach(item => {
            let clase="info";
            if(item.error.includes("❌")) clase="critical";
            else if(item.error.includes("⚠️")) clase="warning";
            else if(item.error.includes("✅")) clase="success";
            html += `<div class="alert ${clase}">${item.error}</div>`;
            html += `<div class="explicacionIA">${item.explicacion}</div>`;
        });
        resultadoDiv.innerHTML=html;
    }catch(e){
        resultadoDiv.innerHTML=`<div class="alert critical">Error conectando con servidor</div>`;
    }
}

async function generarPDF(){
    const data = Object.fromEntries(new FormData(document.getElementById("cargoForm")).entries());
    const resultadoDiv = document.getElementById("resultado");
    resultadoDiv.innerHTML="Generando PDF...";
    try{
        const response = await axios.post("/generar_pdf", data);
        resultadoDiv.innerHTML = `<a href="${response.data.url}" target="_blank">Abrir Reporte PDF</a>`;
    }catch(e){
        resultadoDiv.innerHTML=`<div class="alert critical">Error generando PDF</div>`;
    }
}
</script>
</body>
</html>
