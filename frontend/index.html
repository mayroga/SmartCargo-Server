<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SMARTCARGO – Inspección Infalible</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 0;
}
.container {
    max-width: 900px;
    margin: auto;
    padding: 20px;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 { text-align: center; }
fieldset {
    margin-bottom: 15px;
    padding: 10px 15px;
    border: 2px solid #333;
}
legend { font-weight: bold; }
input, select {
    width: 100%;
    padding: 6px;
    margin: 5px 0 10px 0;
}
input[type="number"] { max-width: 150px; }
button {
    padding: 10px 15px;
    margin-right: 10px;
    cursor: pointer;
}
.error { border-color: red; background: #ffe5e5; }
.hidden { display: none; }
#preview img { max-width: 150px; margin: 5px; cursor: pointer; }
#preview img.zoomed { transform: scale(2); z-index: 100; position: relative; }
.alert { color: red; font-weight: bold; margin-top: 5px; }
</style>
</head>
<body>
<div class="container">
<h1>SMARTCARGO – Inspección Infalible</h1>

<form id="cargoForm">
    <!-- AWB efecto visual -->
    <fieldset>
        <legend>Fase 1: Guía Aérea (AWB)</legend>
        <label>Client ID:</label><input type="text" name="clientId" required>
        <label>AWB Master:</label><input type="text" name="awbMaster" required>
        <label>Origin Airport:</label><input type="text" name="originAirport" required>
        <label>Destination Airport:</label><input type="text" name="destinationAirport" required>
    </fieldset>

    <!-- Fase de Carga -->
    <fieldset>
        <legend>Fase 2: Datos de Carga</legend>
        <label>Tipo de carga:</label>
        <select name="cargoType" id="cargoType" required>
            <option value="">Seleccione...</option>
            <option value="NORMAL">NORMAL</option>
            <option value="DGR">DGR</option>
            <option value="PER">PER</option>
            <option value="BIO">BIO</option>
        </select>

        <label>Altura (in):</label>
        <input type="number" name="pieceHeight" id="pieceHeight" min="0" required>
        <div id="heightAlert" class="alert hidden"></div>

        <label>Peso total:</label>
        <input type="number" name="totalWeight" id="totalWeight" min="0" required>
        <label>Unidad:</label>
        <select name="weightUnit" id="weightUnit">
            <option value="kg">kg</option>
            <option value="lb">lb</option>
        </select>

        <label>¿Requiere Shoring?</label>
        <select name="needsShoring" id="needsShoring">
            <option value="no">No</option>
            <option value="si">Sí</option>
        </select>

        <label>ITN (solo para valor alto >$2,500):</label>
        <input type="text" name="itnNumber" id="itnNumber" placeholder="Debe iniciar con X">
        <div id="itnAlert" class="alert hidden"></div>

        <label>Subir fotos de carga:</label>
        <input type="file" id="files" name="files" multiple accept="image/*">
        <div id="preview"></div>
    </fieldset>

    <!-- Cortina: solo DGR / PER / BIO -->
    <fieldset id="dgrFields" class="hidden">
        <legend>Fase 3: Documentos Críticos (DGR/PER/BIO)</legend>
        <label>Shipper Declaration:</label><input type="text" name="dgrDocs">
        <label>Etiquetas UN:</label><input type="text" name="labels">
        <label>Fitosanitario / FDA:</label><input type="text" name="fitoDocs">
    </fieldset>

    <!-- Pouch -->
    <fieldset>
        <legend>Fase 4: Papelería</legend>
        <label>¿Están los 3 originales DENTRO del sobre y las 6 copias FUERA con clip?</label>
        <select name="pouchOrganized" id="pouchOrganized" required>
            <option value="">Seleccione...</option>
            <option value="si">Sí</option>
            <option value="no">No</option>
        </select>
        <div id="pouchAlert" class="alert hidden">❌ El pouch debe estar organizado para evaluar.</div>
    </fieldset>

    <button type="button" id="evaluateBtn">Evaluar Carga</button>
    <button type="button" id="pdfBtn">Generar PDF</button>
    <button type="button" id="resetBtn">BORRAR DATOS / NUEVA INSPECCIÓN</button>
</form>

<div id="result"></div>

<script>
// ----------------- Cortinas -----------------
const cargoType = document.getElementById("cargoType");
const dgrFields = document.getElementById("dgrFields");
cargoType.addEventListener("change", ()=> {
    if(["DGR","PER","BIO"].includes(cargoType.value)){
        dgrFields.classList.remove("hidden");
    } else {
        dgrFields.classList.add("hidden");
    }
});

// ----------------- Validación tiempo real -----------------
const pieceHeight = document.getElementById("pieceHeight");
const heightAlert = document.getElementById("heightAlert");
pieceHeight.addEventListener("input", ()=>{
    if(pieceHeight.value > 96){
        pieceHeight.classList.add("error");
        heightAlert.textContent = "❌ RECHAZO: Supera el límite máximo de fuselaje de Avianca (96 in).";
        heightAlert.classList.remove("hidden");
    } else if(pieceHeight.value > 63){
        pieceHeight.classList.remove("error");
        heightAlert.textContent = "⚠️ Altura >63 in. Solo apto para carguero.";
        heightAlert.classList.remove("hidden");
    } else{
        pieceHeight.classList.remove("error");
        heightAlert.classList.add("hidden");
    }
});

const itnNumber = document.getElementById("itnNumber");
const itnAlert = document.getElementById("itnAlert");
const totalWeight = document.getElementById("totalWeight");
itnNumber.addEventListener("input", ()=>{
    if(totalWeight.value > 2500 && !itnNumber.value.startsWith("X")){
        itnNumber.classList.add("error");
        itnAlert.textContent = "❌ ITN inválido. Debe iniciar con X para valor >$2,500.";
        itnAlert.classList.remove("hidden");
    } else{
        itnNumber.classList.remove("error");
        itnAlert.classList.add("hidden");
    }
});

// ----------------- Validación Pouch -----------------
const pouchOrganized = document.getElementById("pouchOrganized");
const pouchAlert = document.getElementById("pouchAlert");
const evaluateBtn = document.getElementById("evaluateBtn");
evaluateBtn.addEventListener("click", async ()=>{
    if(pouchOrganized.value !== "si"){
        pouchAlert.classList.remove("hidden");
        return;
    } else pouchAlert.classList.add("hidden");

    const form = document.getElementById("cargoForm");
    const formData = new FormData(form);

    try{
        const response = await axios.post("/evaluar", formData);
        let html = `<h3>Resultado: ${response.data.status}</h3>`;
        html += "<ul>";
        response.data.detalles.forEach(d=> html += `<li>${d}</li>`);
        html += "</ul>";
        html += `<pre>${response.data.explicacion}</pre>`;
        document.getElementById("result").innerHTML = html;
    } catch(e){
        alert("Error conectando con servidor.");
    }
});

// ----------------- Generar PDF -----------------
const pdfBtn = document.getElementById("pdfBtn");
pdfBtn.addEventListener("click", async ()=>{
    if(pouchOrganized.value !== "si"){
        pouchAlert.classList.remove("hidden");
        return;
    } else pouchAlert.classList.add("hidden");

    const form = document.getElementById("cargoForm");
    const formData = new FormData(form);

    try{
        const response = await axios.post("/generar_pdf", formData, {responseType:"blob"});
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download","reporte_smartcargo.pdf");
        document.body.appendChild(link);
        link.click();
        link.remove();
    } catch(e){
        alert("Error generando PDF.");
    }
});

// ----------------- Preview fotos y zoom -----------------
const filesInput = document.getElementById("files");
const preview = document.getElementById("preview");
filesInput.addEventListener("change", ()=>{
    preview.innerHTML = "";
    Array.from(filesInput.files).forEach(file=>{
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.addEventListener("click", ()=> img.classList.toggle("zoomed"));
        preview.appendChild(img);
    });
});

// ----------------- Reset seguro -----------------
document.getElementById("resetBtn").addEventListener("click", ()=>{
    document.getElementById("cargoForm").reset();
    preview.innerHTML = "";
    document.getElementById("result").innerHTML = "";
    heightAlert.classList.add("hidden");
    itnAlert.classList.add("hidden");
    pouchAlert.classList.add("hidden");
});
</script>
</div>
</body>
</html>
